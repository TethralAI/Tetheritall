apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-config
  namespace: default
data:
  redis.conf: |
    bind 0.0.0.0
    port 6379
    protected-mode no
    appendonly yes
  sentinel.conf: |
    port 26379
    dir /data
    sentinel monitor mymaster redis-0.redis 6379 2
    sentinel down-after-milliseconds mymaster 5000
    sentinel failover-timeout mymaster 60000
    sentinel parallel-syncs mymaster 1
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: default
  labels:
    app: redis
spec:
  clusterIP: None
  ports:
    - name: redis
      port: 6379
      targetPort: 6379
    - name: sentinel
      port: 26379
      targetPort: 26379
  selector:
    app: redis
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: default
spec:
  serviceName: redis
  replicas: 3
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 6379
              name: redis
          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /config
          command:
            - sh
            - -c
            - |
              cp /config/redis.conf /data/redis.conf
              redis-server /data/redis.conf &
              sleep 2
              ORDINAL=$(hostname | awk -F- '{print $NF}')
              if [ "$ORDINAL" != "0" ]; then
                # Configure replica to follow redis-0
                redis-cli -h redis-0.redis -p 6379 REPLICAOF redis-0.redis 6379 || true
              fi
              wait
        - name: sentinel
          image: redis:7-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 26379
              name: sentinel
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /data
          command:
            - redis-server
            - /config/sentinel.conf
            - --sentinel
      volumes:
        - name: config
          configMap:
            name: redis-config
            items:
              - key: redis.conf
                path: redis.conf
              - key: sentinel.conf
                path: sentinel.conf
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi